load('./corr_gtop8000_summary_original.rd')
View(sel_genes_w)
dim(sel_genes_w)
?rpkm()
dev.off()
debugSource('~/orange_passport/apa_atingLab2019/02_mRNAseq/04_apafactorexp.r', echo=TRUE)
setwd("~/orange_passport/apa_atingLab2019/02_mRNAseq")
debugSource('~/orange_passport/apa_atingLab2019/02_mRNAseq/04_apafactorexp.r', echo=TRUE)
fc
file.path(args$out_dir,"diffexp.pdf")
p <- ggplot(dt[type=="RestOfGenome",],aes(x=args$ctrl,y=args$ctrl)) +
geom_point() +
geom_point(data=dt[type!="RestOfGenome",],color="red",aes(x=args$ctrl,y=args$expr)) +
handy::ggnice() +
geom_hline(yintercept=0) +
geom_vline(xintercept=0) +
labs(x=sprintf("RNA-seq log2(RPKM) in %s",args$ctrl),y=sprintf("RNA-seq log2(RPKM) in %s",args$expr))
print(p)
dt
map$id
dt[,type=='CpA_Factors']
which(dt[,type=='CpA_Factors'])
p <- ggplot(dt[type=="RestOfGenome",],aes(x=args$ctrl,y=args$expr)) +
geom_point() +
geom_point(data=dt[type!="RestOfGenome",],color="red",aes(x=args$ctrl,y=args$expr)) +
handy::ggnice() +
geom_hline(yintercept=0) +
geom_vline(xintercept=0) +
labs(x=sprintf("RNA-seq log2(RPKM) in %s",args$ctrl),y=sprintf("RNA-seq log2(RPKM) in %s",args$expr))
print(p)
print(p)
p <- ggplot(dt[type=="RestOfGenome",],aes(x="HCT116",y="DKO")) +
geom_point()
print(p)
dt
dev.off()
library(ggplot2)
p <- ggplot(dt[type=="RestOfGenome",],aes(x="HCT116",y="DKO")) +
geom_point() +
geom_point(data=dt[type!="RestOfGenome",],color="red",aes(x=args$ctrl,y=args$expr)) +
handy::ggnice() +
geom_hline(yintercept=0) +
geom_vline(xintercept=0) +
labs(x=sprintf("RNA-seq log2(RPKM) in %s",args$ctrl),y=sprintf("RNA-seq log2(RPKM) in %s",args$expr))
plot(p)
print(p)
dev.off()
data.class(dt)
colnames(dt)
ggplot(dt,aes(x=HCT116,y=DKO)) + geom_point()
dt$type <- "1.RestOfGenome"
dt[match(map$id,dt$gene),]$type <- "2.CpA_Factors"
p <- ggplot(dt,aes(x=args$ctrl,y=args$expr,color=type) +
geom_point() +
handy::ggnice() +
geom_hline(yintercept=0) +
geom_vline(xintercept=0) +
labs(x=sprintf("RNA-seq log2(RPKM) in %s",args$ctrl),y=sprintf("RNA-seq log2(RPKM) in %s",args$expr))
)
p <- ggplot(dt,aes(x=args$ctrl,y=args$expr,color=type)) +
scale_color_manual(values=c("#999999", "#E69F00")) +
geom_point() +
handy::ggnice() +
geom_hline(yintercept=0) +
geom_vline(xintercept=0) +
labs(x=sprintf("RNA-seq log2(RPKM) in %s",args$ctrl),y=sprintf("RNA-seq log2(RPKM) in %s",args$expr))
plot(p)
dt
p <- ggplot(dt[type=="RestOfGenome",],aes(x=get(args$ctrl),y=get(args$expr))) +
geom_point() +
geom_point(data=dt[type!="RestOfGenome",],color="red",aes(x=args$ctrl,y=args$expr)) +
handy::ggnice() +
geom_hline(yintercept=0) +
geom_vline(xintercept=0) +
labs(x=sprintf("RNA-seq log2(RPKM) in %s",args$ctrl),y=sprintf("RNA-seq log2(RPKM) in %s",args$expr))
print(p)
p <- ggplot(dt,aes(x=HCT116,y=DKO,color=type)) +
scale_color_manual(values=c("#999999", "#E69F00")) +
geom_point() +
handy::ggnice() +
geom_hline(yintercept=0) +
geom_vline(xintercept=0) +
labs(x=sprintf("RNA-seq log2(RPKM) in %s",args$ctrl),y=sprintf("RNA-seq log2(RPKM) in %s",args$expr))
plot(p)
pdf(file=file.path(args$out_dir,"diffexp.pdf"))
p <- ggplot(dt,aes(x=HCT116,y=DKO,color=type)) +
scale_color_manual(values=c("#999999", "#ff0000")) +
geom_point() +
handy::ggnice() +
geom_hline(yintercept=0) +
geom_vline(xintercept=0) +
labs(x=sprintf("RNA-seq log2(RPKM) in %s",args$ctrl),y=sprintf("RNA-seq log2(RPKM) in %s",args$expr)) +
theme(legend.position="bottom")
print(p)
dev.off()
dt[type=='2.CpA_Factors',]
fac <- dt[type=="2.CpA_Factors",]
map$name
map
fac
fac[match(map$id,fac$gene),]$type <- map$name
fac
fac$gene_symbol <- as.character()
gen
fac <- dt[type=="2.CpA_Factors",]
fac$gene_symbol <- ""
fac[match(map$id,fac$gene),]$gene_symbol <- map$name
gen
fac$class <- ""
fac[match(gen$gene,fac$gene_symbol),]$class <- gen$type
#fac$fc <- log2(with(fac,get(args$expr)/get(args$ctrl)))
fac$fc <- fac[,get(args$expr)] - fac[,get(args$ctrl)]
fac <- fac[order(fac$fc),]
fac$gene_symbol <- factor(fac$gene_symbol,levels=fac$gene_symbol)
pdf(file=file.path(args$out_dir,"pa_factor_exp_rev2.pdf"),width=6,height = 4)
fac
p <- ggplot(fac,aes(x=gene_symbol,y=fc,fill=class)) +
geom_bar(stat="identity") +
handy::ggnice() +
coord_flip() +
scale_y_continuous(limits=c(-1,1)) +
labs(x="",y=sprintf("log2(%s/%s) Gene Expression",args$expr,args$ctrl))
print(p)
p <- ggplot(fac,aes(x=gene_symbol,y=fc,fill=class)) +
geom_bar(stat="identity") +
handy::ggnice() +
coord_flip() +
scale_y_continuous(limits=c(-1.5,1)) +
labs(x="",y=sprintf("log2(%s/%s) Gene Expression",args$expr,args$ctrl))
dev.off()
pdf(file=file.path(args$out_dir,"pa_factor_exp_rev2.pdf"),width=6,height = 4)
p <- ggplot(fac,aes(x=gene_symbol,y=fc,fill=class)) +
geom_bar(stat="identity") +
handy::ggnice() +
coord_flip() +
scale_y_continuous(limits=c(-1.5,1)) +
labs(x="",y=sprintf("log2(%s/%s) Gene Expression",args$expr,args$ctrl))
print(p)
dev.off()
colSums(mat)
ret <- calcNormFactors(mat)
ret
?calcNormFactors
1700 * 83/130
1700 / 131
583 / 83
log2(7/12.9)
mat['ENSG00000167005',]
48960/131
log2(135/373.7)
?DGEList
mat2 <- DGEList(counts=mat,genes=fc$Length)
mat2 <- calcNormFactors(mat2)
rpkm <- rpkm(mat2,log=TRUE)
mat2 <- DGEList(counts=mat,genes=fc2$Length)
mat2 <- calcNormFactors(mat2)
rpkm <- rpkm(mat2,log=TRUE)
dt <- data.table(rpkm)
dt$gene <- fc2$GeneID
dt <- dt[rowSums(mat2)>0,]
dt
fac <- dt[type=="2.CpA_Factors",]
fac$gene_symbol <- ""
fac[match(map$id,fac$gene),]$gene_symbol <- map$name
dt[match(map$id,dt$gene),]$type <- "2.CpA_Factors"
dt <- data.table(rpkm)
dt$gene <- fc2$GeneID
head(mat2)
mat2
dt <- dt[rowSums(mat2$counts)>0,]
dt$type <- "1.RestOfGenome"
dt[match(map$id,dt$gene),]$type <- "2.CpA_Factors"
library(ggplot2)
fac <- dt[type=="2.CpA_Factors",]
fac$gene_symbol <- ""
fac[match(map$id,fac$gene),]$gene_symbol <- map$name
fac$class <- ""
fac[match(gen$gene,fac$gene_symbol),]$class <- gen$type
#fac$fc <- log2(with(fac,get(args$expr)/get(args$ctrl)))
fac$fc <- fac[,get(args$expr)] - fac[,get(args$ctrl)]
fac <- fac[order(fac$fc),]
fac$gene_symbol <- factor(fac$gene_symbol,levels=fac$gene_symbol)
p <- ggplot(fac,aes(x=gene_symbol,y=fc,fill=class)) +
geom_bar(stat="identity") +
handy::ggnice() +
coord_flip() +
scale_y_continuous(limits=c(-1.5,1)) +
labs(x="",y=sprintf("log2(%s/%s) Gene Expression",args$expr,args$ctrl))
print(p)
pdf(file=file.path(args$out_dir,"pa_factor_exp.pdf"),width=6,height = 4)
p <- ggplot(fac,aes(x=gene_symbol,y=fc,fill=class)) +
geom_bar(stat="identity") +
handy::ggnice() +
coord_flip() +
scale_y_continuous(limits=c(-1.5,1)) +
labs(x="",y=sprintf("log2(%s/%s) Gene Expression",args$expr,args$ctrl))
print(p)
dev.off()
debugSource('~/orange_passport/apa_atingLab2019/02_mRNAseq/04_apafactorexp.r', echo=TRUE)
tpm
tpm_log2 <- log2(tpm)
tpm_log2
ret <- colSums(tpm)
ret
mat
mat2 <- mat/(fc2$Length/1e3) #rpk
depth_sf <- colSums(mat2)/1e6 #scaling factor
tpm <- mat2/depth_sf #rpk/scaling factor
ret <- colSums(tpm)
ret
depth_sf
colSums(mat2)
names(mat2)
colnames(mat2)
mat2$HCT116/33.88573
mat2[,'HCT116']/33.88573
sum(mat2[,'HCT116']/33.88573)
data.class(mat2)
data.class(depth_sf)
depth_sf[1]
tpm <- apply(1:2,norm<-function(i){return(mat2[,i]/depth_sf[i])}) #rpk/scaling factor
tpm <- apply(1:2,function(i){return(mat2[,i]/depth_sf[i])}) #rpk/scaling factor
tpm <- lapply(1:2,function(i){return(mat2[,i]/depth_sf[i])}) #rpk/scaling factor
colSums(tpm)
tpm
tpm <- sapply(1:2,function(i){return(mat2[,i]/depth_sf[i])}) #rpk/scaling factor
dim(tpm)
ret <- colSums(tpm)
ret
tpm_log2 <- log2(tpm)
dt <- data.table(tpm_log2)
dt$gene <- fc2$GeneID
table(rowSums(mat)==0)
#dt <- dt[rowSums(mat)>0,]
dt <- dt[!is.infinite(HCT116) & !is.infinite(DKO),]
dt$type <- "1.RestOfGenome"
dt[match(map$id,dt$gene),]$type <- "2.CpA_Factors"
library(ggplot2)
pdf(file=file.path(args$out_dir,"diffexp.pdf"))
p <- ggplot(dt,aes(x=HCT116,y=DKO,color=type)) +
scale_color_manual(values=c("#999999", "#ff0000")) +
geom_point() +
handy::ggnice() +
geom_hline(yintercept=0) +
geom_vline(xintercept=0) +
labs(x=sprintf("RNA-seq log2(TPM) in %s",args$ctrl),y=sprintf("RNA-seq log2(TPM) in %s",args$expr)) +
theme(legend.position="bottom")
print(p)
dt
tpm <- sapply(1:2,function(i){return(mat2[,i]/depth_sf[i])}) #rpk/scaling factor
colnames(tpm) <- c(args$ctrl,args$expr)
tpm_log2 <- log2(tpm)
dt <- data.table(tpm_log2)
dt$gene <- fc2$GeneID
#dt <- dt[rowSums(mat)>0,]
dt <- dt[!is.infinite(HCT116) & !is.infinite(DKO),]
dt$type <- "1.RestOfGenome"
dt[match(map$id,dt$gene),]$type <- "2.CpA_Factors"
pdf(file=file.path(args$out_dir,"diffexp.pdf"))
p <- ggplot(dt,aes(x=HCT116,y=DKO,color=type)) +
scale_color_manual(values=c("#999999", "#ff0000")) +
geom_point() +
handy::ggnice() +
geom_hline(yintercept=0) +
geom_vline(xintercept=0) +
labs(x=sprintf("RNA-seq log2(TPM) in %s",args$ctrl),y=sprintf("RNA-seq log2(TPM) in %s",args$expr)) +
theme(legend.position="bottom")
print(p)
dev.off()
dev.off()
dev.off()
pdf(file=file.path(args$out_dir,"diffexp.pdf"))
p <- ggplot(dt,aes(x=HCT116,y=DKO,color=type)) +
scale_color_manual(values=c("#999999", "#ff0000")) +
geom_point() +
handy::ggnice() +
geom_hline(yintercept=0) +
geom_vline(xintercept=0) +
labs(x=sprintf("RNA-seq log2(TPM) in %s",args$ctrl),y=sprintf("RNA-seq log2(TPM) in %s",args$expr)) +
theme(legend.position="bottom")
print(p)
dev.off()
fac <- dt[type=="2.CpA_Factors",]
fac$gene_symbol <- ""
fac[match(map$id,fac$gene),]$gene_symbol <- map$name
fac$class <- ""
fac[match(gen$gene,fac$gene_symbol),]$class <- gen$type
#fac$fc <- log2(with(fac,get(args$expr)/get(args$ctrl)))
fac$fc <- fac[,get(args$expr)] - fac[,get(args$ctrl)]
fac <- fac[order(fac$fc),]
fac$gene_symbol <- factor(fac$gene_symbol,levels=fac$gene_symbol)
pdf(file=file.path(args$out_dir,"pa_factor_exp.pdf"),width=6,height = 4)
p <- ggplot(fac,aes(x=gene_symbol,y=fc,fill=class)) +
geom_bar(stat="identity") +
handy::ggnice() +
coord_flip() +
scale_y_continuous(limits=c(-1.5,1)) +
labs(x="",y=sprintf("log2(%s/%s) Gene Expression",args$expr,args$ctrl))
print(p)
dev.off()
fac
View(fac)
mat['ENSG00000167005',]
rownames(tpm)
tpm['ENSG00000167005',]
mat['ENSG00000167005',]
depth_sf
mat2['ENSG00000167005',]
8944.099 / 33.88573
2047.863 / 22.84050
263.94888 / 89.65929
8944.099 / 2047.863
?featureCounts
setwd("~/projects/apa/src/s12_tcga_summary")
debugSource('~/projects/apa/src/s12_tcga_summary/01_collapse_corr_mpts.r', echo=TRUE)
pcc
sel_genes <- pcc
sel_genes_l <- sel_genes
library(reshape2)
sel_genes[cohort=='merged',cohort:='Vmerged']
sel_genes_w <- as.data.table(dcast(sel_genes, gene_name + probe_pos ~ cohort, value.var="pearson.r2"))
sel_genes_w$chr <- sapply(strsplit(sel_genes_w$probe_pos,':'),function(chr_pos){chr_pos[[1]]})
sel_genes_w$start <- sapply(strsplit(sel_genes_w$probe_pos,':'),function(chr_pos){as.integer(chr_pos[[2]])})
sel_genes_w <- sel_genes_w[order(chr,start)]
setnames(sel_genes_w,'Vmerged','merged')
sel_genes_w$chr <- NULL
sel_genes_w$start <- NULL
sel_genes_w[is.na(sel_genes_w)] <- 0.
sel_genes_w
pcc
sel_genes <- pcc
sel_genes_l <- sel_genes
sel_genes
sel_genes[cohort=='merged',cohort:='Vmerged']
dcast(sel_genes, gene_name + probe_pos ~ cohort, value.var="pearson.r2")
sel_genes[pearson.r2,]
sel_genes[,pearson.r2]
is.na(sel_genes[,pearson.r2])
sel_genes <- as.data.table(pcc[, .SD[which.max(abs(pearson.r2))], by=c(probe_pos,gene_name)])
pcc
sel_genes <- as.data.table(pcc[, .SD[which.max(abs(pearson.r2))], by=c('probe_pos','gene_name')])
sel_genes
sel_prob_pos <- unique(sel_genes[,list(test_id,probe_pos)])
sel_genes <- pcc[(test_id %in% sel_prob_pos$test_id & probe_pos %in% sel_prob_pos$probe_pos),]
sel_genes[cohort=='merged',cohort:='Vmerged']
sel_genes_w <- as.data.table(dcast(sel_genes, gene_name + probe_pos ~ cohort, value.var="pearson.r2"))
sel_genes
sel_genes_w <- as.data.table(dcast(sel_genes, test_id + probe_pos ~ cohort, value.var="pearson.r2"))
sel_genes_w
View(sel_genes)
sel_genes <- as.data.table(pcc[, .SD[which.max(abs(pearson.r2))], by=c('probe_pos','gene_name')])
sel_prob_pos <- unique(sel_genes[,list(test_id,probe_pos)])
sel_prob_pos
sel_genes <- pcc[(test_id %in% sel_prob_pos$test_id & probe_pos %in% sel_prob_pos$probe_pos),]
sel_genes[cohort=='merged',cohort:='Vmerged']
View(sel_genes)
as.data.table(dcast(sel_genes, gene_name + probe_pos ~ cohort, value.var="pearson.r2"))
debugSource('~/projects/apa/src/s12_tcga_summary/01_collapse_corr_mpts.r', echo=TRUE)
debugSource('~/projects/apa/src/s12_tcga_summary/01_collapse_corr_mpts.r', echo=TRUE)
sel_genes_w
sel_genes
pcc
gene_map <- unique(pcc[,list(test_id,gene_name)])
sel_genes_w[match(gene_map$test_id,sel_genes_w$test_id),]
sel_genes_w
gene_map
sel_genes_w[match(gene_map$test_id,sel_genes_w$test_id),gene_name:=gene_map$gene_name]
writeData(wb,sheet=sheet_name,x=sel_genes_w)
sheet_name <- 'pearson_qval'
library(openxlsx)
writeData(wb,sheet=sheet_name,x=sel_genes_w)
wb <- createWorkbook()
sheet_name <- 'pearson_r2'
addWorksheet(wb,sheet_name)
sel_genes_w$gene_name <- ""
sel_genes_w[match(gene_map$test_id,sel_genes_w$test_id),gene_name:=gene_map$gene_name]
writeData(wb,sheet=sheet_name,x=sel_genes_w)
sheet_name <- 'pearson_qval'
addWorksheet(wb,sheet_name)
sel_genes2_w$gene_name <- ""
sel_genes2_w[match(gene_map$test_id,sel_gene2s_w$test_id),gene_name:=gene_map$gene_name]
source('~/projects/apa/src/s12_tcga_summary/01_collapse_corr_mpts.r', echo=TRUE)
source('~/projects/apa/src/s12_tcga_summary/01_collapse_corr_mpts.r', echo=TRUE)
sel_genes_w
sel_genes_w[gene_map$test_id %in% sel_genes_w$test_id,gene_name:=gene_map$gene_name]
sel_genes_w[gene_map$test_id %in% sel_genes_w$test_id,]
sel_genes_w[sel_genes_w$test_id %in% gene_map$test_id,]
merge(sel_genes_w,gene_map,by=test_id)
merge(sel_genes_w,gene_map,by='test_id')
source('~/projects/apa/src/s12_tcga_summary/01_collapse_corr_mpts.r', echo=TRUE)
source('~/projects/apa/src/s12_tcga_summary/01_collapse_corr_mpts.r', echo=TRUE)
sel_genes
sel_genes3_w <- as.data.table(dcast(sel_genes, test_id ~ cohort, value.var="data_points"))
sel_genes3_w
sel_genes3_w <- as.data.table(dcast(sel_genes, test_id + probe_pos ~ cohort, value.var="data_points"))
sel_genes3_w
source('~/projects/apa/src/s12_tcga_summary/01_collapse_corr_mpts.r', echo=TRUE)
source('~/projects/apa/src/s12_tcga_summary/01_collapse_corr_mpts.r', echo=TRUE)
??rpkm
??featureCounts
setwd("~/orange_passport/apa_atingLab2019/artwork/original/supplementary_doc")
library(openxlsx)
fn <- './Supplementary_Table_S6.xlsx'
dt <- as.data.table(read.xlsx(fn,sheet=2))
dt
View(dt)
dt[,merged>0.]
j <- which(dt[,merged>0.])
j
dt[j,num_valid_cohorts]
dt[j,num_valid_cohorts] - 1
dt[,2:12]!=0
rowSums(dt[,2:12]!=0)
View(rowSums(dt[,2:12]!=0))
scnz <- rowSums(dt[,2:12]!=0)
scnz
which(scnz>0)
length(which(scnz>0))
which(scnz>0)
j <- which(scnz>0)
dt[j,gene_test_id]
gene_ti <- dt[j,gene_test_id]
ugene_ti <- unique(gene_ti)
View(ugene_ti)
ret <- strsplit(ugene_ti,sep='[')
ret <- strsplit(ugene_ti,'[')
ret <- strsplit(ugene_ti,'\[')
??strsplit
ret <- tstrsplit(ugene_ti,'[')
ret <- tstrsplit(ugene_ti,"[")
ret <- tstrsplit(ugene_ti,"\[")
ret <- tstrsplit(ugene_ti,"\\[")
ret
ret[[1]]
unique(ret[[1]])
length(unique(ret[[1]]))
ret
View(unique(ret[[1]]))
fwrite(unique(ret[[1]]),file='./unique_genes.txt')
fwrite(unlist(unique(ret[[1]])),file='./unique_genes.txt')
fwrite(as.data.table(unique(ret[[1]])),file='./unique_genes.txt')
dt[j,]
View(dt[j,])
dt[j,merged==0.]
which(dt[j,merged==0.])
length(which(dt[j,merged==0.]))
dt[j,merged==0.]
ugene1 <- as.data.table(unique(ret[[1]]))
ugene1
dte <-as.data.table(read.xlsx('/home/hongc2/projects/apa/src/s12_tcga_summary/debug/atleast1_cohort_gene_list.xlsx',sheet = 4))
dte
setdiff(ugene1,dte)
setdiff(ugene1$V1,dte$gene_test_id)
View(setdiff(ugene1$V1,dte$gene_test_id))
fwrite(as.data.table(setdiff(ugene1$V1,dte$gene_test_id)),file='diff_genes.txt')
q()
